# mysql 索引优化

## 1. 聚集索引和非聚集索引

- 聚集索引：该索引中键值的逻辑顺序决定了表中相应行的物理顺序，即索引的叶节点指向数据。

>对于那些经常要搜索范围值的列特别有效。使用聚集索引找到包含第一个值的行后，便可以确保包含后续索引值的行在物理相邻。

- 非聚集索引：该索引中索引的逻辑顺序与磁盘上行的物理存储顺序不同，即索引的叶节点指向数据的引用。

>当搜索使用到非聚集索引时，需要回归到对应的物理行(聚集索引)，除非这个索引覆盖了所有要查询的列。

- mysql 的存储引擎到目前为止都不支持自定义聚集索引，InnoDB默认对主键建立聚簇索引。如果你不指定主键，InnoDB会用一个具有唯一且非空值的索引来代替。如果不存在这样的索引，InnoDB会定义一个隐藏的主键，然后对其建立聚簇索引。

## 2. b-tree 索引限制

**以下说明均以这个 table 和 index 为例子：**

```
table t(varchar a, varchar b, int c)
index i(a,b,c)
primary key(a)
```

1. 查询必须从索引的最左边的列开始，并且不能跳过某一索引列

  - `select a from t where b = "aaa"`: 无法使用到索引i，因为没法使用第一列(a列)索引
  - `select a from t where a = "aaa"`: 只使用到索引i的第一列(a列)
  - `select a from t where a = "aaa" and b = "aaa"`: 使用到索引i的a列和b列
  - `select a from t where a = "aaa" and c = 1`: 只使用到索引i的第一列(a列)，因为不能跳过b列使用c列

2. 存储引擎不能使用索引中范围条件右边的列
  
  - `select a from t where a = "aaa" and b like "aaa%" and c=1`: 使用到索引i的a列和b列，因为`b like "aaa%` 属于范围查找，因此它索引右边的列(c列)索引不能使用到

3. like 查询列索引需要匹配前缀
  - `select a from t where a = "aaa" and b like "%aaa%" and c=1`: 只使用到索引i的第一列(a列)，因为`b like "%aaa%`前缀模糊，不能使用到b列的索引

## 3. 索引与加锁

Inndb 支持行锁，原理是 InnoDB 仅对需要访问的元组加锁，而索引能够减少 InnoDB 访问的元组数。如果不使用索引，那么就会和表锁一样锁住整个表。

Innodb 事务隔离级别：

  - Read uncommitted (未提交读)：读写都不加锁
  - Read committed (已提交读)：写加锁，其他不能写，只能读
  - Repeatable read (可重复读)：读写都加锁，其他不能写，只能读
  - Serializable (可串行化)：读写都加锁，其他都不能读写

## 4. b-tree 以外的索引

1. Hash索引：只有Memory存储引擎显示支持hash索引。
  - 由于索引仅包含hash code和记录指针，所以，MySQL不能通过使用索引避免读取记录。但是访问内存中的记录是非常迅速的，不会对性造成太大的影响。
  - 不能使用hash索引排序。
  - Hash索引不支持键的部分匹配，因为是通过整个索引值来计算hash值的。
  - Hash索引只支持等值比较，例如使用=，in( )和<=>。对于 where c > 100 并不能加速查询。

2. 空间(R-Tree)索引：MyISAM支持空间索引，主要用于地理空间数据类型，例如GEOMETRY。

3. 全文(Full-text)索引：全文索引是MyISAM的一个特殊索引类型，主要用于全文检索。

## 5. 优化手段

1. InnoDB 中，按主键 (primary key) 的顺序插入行，一个好的做法就是使用代理主键(surrogate key)——独立于你的应用中的数据。最简单的做法就是使用一个AUTO_INCREMENT的列，这会保证记录按照顺序插入，而且能提高使用primary key进行连接的查询的性能。

2. 非聚集索引覆盖到查询的所有列，因为非聚集索引使用后，还需要回归到聚集索引找到对应的物理地址，在去获取其他列的值，但是如果是覆盖索引，那么就可以直接获取到查询列的值，而不需要回归到聚集索引。

- 例子：`select b from t where a=1`

  - 如果设置索引为a，使用了这个索引之后，还需要寻找对应的物理地址再获取b的值
  - 如果设置索引为(a,b)，使用了这个索引之后就直接获取到a的值

3. 在 order by 的列上使用索引，因为索引结构是 b-tree，因此搜索效率会比较高